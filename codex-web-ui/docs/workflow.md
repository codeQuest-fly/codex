# Codex Web UI 工作流程

## 核心工作流程

### 1. 任务创建和执行流程

```
+----------------+     +----------------+     +----------------+
|                |     |                |     |                |
|  创建任务描述  |---->|  提交任务请求  |---->|  任务排队/调度 |
|                |     |                |     |                |
+----------------+     +----------------+     +----------------+
                                                      |
                                                      v
+----------------+     +----------------+     +----------------+
|                |     |                |     |                |
|  查看任务结果  |<----|  任务状态更新  |<----|  执行 Codex CLI|
|                |     |                |     |                |
+----------------+     +----------------+     +----------------+
        |                                             ^
        v                                             |
+----------------+     +----------------+     +----------------+
|                |     |                |     |                |
|  审核文件变更  |---->|  批准/拒绝变更 |---->|  应用/丢弃变更 |
|                |     |                |     |                |
+----------------+     +----------------+     +----------------+
```

### 2. 文件浏览和编辑流程

```
+----------------+     +----------------+     +----------------+
|                |     |                |     |                |
|  浏览文件结构  |---->|  选择文件查看  |---->|  打开代码编辑器|
|                |     |                |     |                |
+----------------+     +----------------+     +----------------+
                                                      |
                                                      v
+----------------+     +----------------+     +----------------+
|                |     |                |     |                |
|  查看文件列表  |<----|  保存文件内容  |<----|  编辑代码      |
|                |     |                |     |                |
+----------------+     +----------------+     +----------------+
```

### 3. 人机交互流程

```
+----------------+     +----------------+     +----------------+
|                |     |                |     |                |
|  Codex 请求交互|---->|  显示交互请求  |---->|  用户提供响应  |
|                |     |                |     |                |
+----------------+     +----------------+     +----------------+
        ^                                             |
        |                                             v
+----------------+     +----------------+     +----------------+
|                |     |                |     |                |
|  继续执行任务  |<----|  处理用户响应  |<----|  提交响应      |
|                |     |                |     |                |
+----------------+     +----------------+     +----------------+
```

### 4. 任务中断和回滚流程

```
+----------------+     +----------------+     +----------------+
|                |     |                |     |                |
|  查看运行任务  |---->|  请求中断任务  |---->|  终止 Codex 进程|
|                |     |                |     |                |
+----------------+     +----------------+     +----------------+
                                                      |
                                                      v
+----------------+     +----------------+     +----------------+
|                |     |                |     |                |
|  查看任务列表  |<----|  更新任务状态  |<----|  清理资源      |
|                |     |                |     |                |
+----------------+     +----------------+     +----------------+

+----------------+     +----------------+     +----------------+
|                |     |                |     |                |
|  查看已完成任务|---->|  请求回滚任务  |---->|  获取变更列表  |
|                |     |                |     |                |
+----------------+     +----------------+     +----------------+
                                                      |
                                                      v
+----------------+     +----------------+     +----------------+
|                |     |                |     |                |
|  查看任务列表  |<----|  更新任务状态  |<----|  恢复原始文件  |
|                |     |                |     |                |
+----------------+     +----------------+     +----------------+
```

## 详细工作流程

### 任务创建和执行

1. **创建任务**
   - 用户在界面上填写任务描述
   - 选择任务类型（代码生成、代码修改、代码分析等）
   - 设置任务参数（立即执行或定时执行、审批模式等）
   - 提交任务请求

2. **任务调度**
   - 后端接收任务请求
   - 生成唯一任务 ID
   - 将任务信息保存到数据库
   - 如果是定时任务，设置定时器
   - 如果是立即执行任务，加入执行队列

3. **任务执行**
   - 从队列中获取任务
   - 更新任务状态为"运行中"
   - 启动 Codex CLI 进程
   - 传递任务描述和参数
   - 监听 Codex CLI 输出

4. **实时更新**
   - 通过 WebSocket 向前端发送实时输出
   - 更新任务状态和进度
   - 处理交互请求

5. **任务完成**
   - Codex CLI 执行完成
   - 解析输出结果和文件变更
   - 更新任务状态为"已完成"或"失败"
   - 通知前端任务完成

### 文件变更审批

1. **查看变更**
   - 用户在任务详情页查看文件变更列表
   - 查看每个文件的变更内容（差异对比）

2. **审批变更**
   - 用户可以批准或拒绝每个文件变更
   - 批准的变更将被应用到文件系统
   - 拒绝的变更将被丢弃

3. **应用变更**
   - 后端接收审批结果
   - 对于批准的变更，写入文件系统
   - 更新变更状态为"已应用"或"已拒绝"

### 人机交互

1. **交互请求**
   - Codex CLI 在执行过程中可能需要用户输入
   - 后端捕获交互请求并通过 WebSocket 发送给前端

2. **用户响应**
   - 前端显示交互请求（确认、输入、选择等）
   - 用户提供响应
   - 前端将响应发送给后端

3. **继续执行**
   - 后端将用户响应传递给 Codex CLI
   - Codex CLI 继续执行任务

### 任务中断和回滚

1. **中断任务**
   - 用户请求中断正在运行的任务
   - 后端终止 Codex CLI 进程
   - 更新任务状态为"已中断"
   - 清理相关资源

2. **回滚任务**
   - 用户请求回滚已完成的任务
   - 后端获取任务的文件变更列表
   - 对于每个变更，恢复原始文件
   - 更新任务状态为"已回滚"